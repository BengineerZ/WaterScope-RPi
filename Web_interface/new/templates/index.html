<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="">
		<meta name="author" content="Tianheng from WaterScope">
		<link rel="icon" href="WaterScope-icon.png">
		<!-- CSS to make the thing works-->
		<style>
			body {padding-top: 5rem;}
			.starter-template {
			padding: 3rem 1.5rem;
			text-align: center;
			}
		</style>
		<!--
		<link rel="stylesheet" type="text/css" href="static/style.css">
		-->





		<title>WaterScope Web Interface</title>


	
		
	</head>

	
	<body>



		<nav class="navbar navbar-toggleable-md navbar-inverse bg-inverse fixed-top">
			<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<a class="navbar-brand" href="#">WaterScope Web Interface</a>

			<div class="collapse navbar-collapse" id="navbarsExampleDefault">
				<ul class="navbar-nav mr-auto">
					<li class="nav-item active">
						<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
					</li>
				</ul>
			</div>
		</nav>

		
<!--		<div class="container">
			<div class="starter-template">
				<h1>WaterScope Web Interface</h1>
				<p class="lead">Use this document as a way to quickly start any new project.<br> All you get is this text and a mostly barebones HTML document.</p>
			</div>
		</div>
-->

		<!-- Streaming window etc-->
		<div class="container-fluid text-center ">
			<div class="row justify-content-around">
				<div class="col">
					<!-- MJPEG streaming container -->
					<div id="stream_container" class="stream_conatiner button"></div>
				</div>
			</div>
			<br>
				<!-- image capture and preview button-->
			<div class="row justify-content-around">   
				<div class="col">   
					<button type="button" class="btn btn-success" onclick="start_stream();">Start streaming</button>
					<button type="button" class="btn btn-danger" onclick="stop_stream()";>Stop streaming</button>
					<button class="btn btn-primary" onclick="capture(camera_params);">Save image</button>
					<!-- a hidden button to download the jpeg-->
					<a id="capture_link" href="static/capture.jpg" hidden download>Download</a>
					<!-- Run script with time.sleep() without refreshing page using ajax-->
					<button id="time_lapse_button" class="btn btn-success" type="submit">Start time-lapse</button>
				</div>
			</div>
		</div>
		<br>



		<div class="container-fluid text-center">
			<div class="row justify-content-around">
				<div class="col-xs-5 ">
					<!-- xy movement-->
					<div class="row justify-content-center">
						<h5>X-Y</h5>
					</div>
					<div class="row justify-content-center">
						<button type="button" class="btn btn-warning" onclick="move(0, 2000, 0);">&#x25B2</button>
					</div>
					<div class="row justify-content-center">
						<button type="button" class="btn btn-warning" onclick="move(-2000, 0, 0);">&#x25C0;&#xFE0E;</button>
						&emsp;
						<button type="button" class="btn btn-warning" onclick="move(2000, 0, 0);">&#x25BA</button>
					</div>
					<div class="row justify-content-center">
						<button type="button" class="btn btn-warning" onclick="move(0, -2000, 0);">&#x25BC</button>
					</div>
				</div>

				<div class="col-xs-5">
					<!-- z movement-->
					<div class="row justify-content-center">
						<h5>Focus</h5>
					</div>
					<div class="row justify-content-center">
						<button type="button" class="btn btn-warning" onclick="move(0, 0, 2000);">&#x25B2</button>
					</div>
					<br>
					<div class="row justify-content-center">
						<button type="button" class="btn btn-warning" onclick="move(0, 0, -2000);">&#x25BC</button>
					</div>
				</div>
			</div>
		</div>

		<br>


		<div class="container-fluid text-center">
			<div class="row justify-content-around">
				<div class="col">
					
					<!-- Nav tabs -->
					<ul class="nav nav-tabs" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" data-toggle="tab" href="#brightness_pane" role="tab">Brightness</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" data-toggle="tab" href="#contrast_pane" role="tab">Contrast</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" data-toggle="tab" href="#white_balance_pane" role="tab">White balance</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" data-toggle="tab" href="#file_path_pane" role="tab">File path</a>
						</li>
					</ul>

					<!-- Tab panes -->
					<div class="tab-content">
						<div class="tab-pane fade show active" id="brightness_pane" role="tabpanel">
							Brigthness:
							<h3 id = "brightness_text">40</h3>
							<input id = "brightness_slider" type="range" min="0" max="100" step="5" value = "40" />
						</div>
						<div class="tab-pane fade" id="contrast_pane" role="tabpanel">
							Contrast:
							<h3 id = "contrast_text">40</h3>
							<input id = "contrast_slider" type="range" min="0" max="100" step="5" value = "40" />
						</div>
						<div class="tab-pane fade" id="white_balance_pane" role="tabpanel">
							Blue gain:
							<h3 id = "blue_gain_text">40</h3>
							<input id = "blue_gain_slider" type="range" min="0" max="100" step="5" value = "40" />
							<br>
							Red gain:
							<h3 id = "red_gain_text">40</h3>
							<input id = "red_gain_slider" type="range" min="0" max="100" step="5" value = "40" />
						</div>
						<div class="tab-pane fade" id="file_path_pane" role="tabpanel">
							File path:
							<input id = "file_path_text" type="text" value = "/home/pi/images/"/>
						</div>
					</div>
				</div>
			</div>
		</div>
		<br>


		<!-- test python time lapse script (with time.sleep function) runs in server end-->
		<form action="/time_lapse_module" method="post">
			<button  name="test" class="btn btn-danger" type="submit">Time lapse</button>
		</form>

		<!-- Run script with time.sleep() without refreshing page using ajax-->
		<button id="test_button" class="btn btn-danger" type="submit">Time lapse + ajax</button>


		<!-- obtain values in inputs and run python script-->
		<button  id="update_parameters_button" class="btn btn-danger" type="submit">Update parameters</button>


		<!-- obtain values in inputs and run python script-->
		<form action="read_parameters" >
			<button  id="read_parameters_button_1" class="btn btn-danger" type="submit" href="/">Read parameters from last time</button>
		</form>
		<p id = 'parameter_text_1'> saved parameters: </p>

		<button  id="read_parameters_button" class="btn btn-danger" type="submit" href="/">Read parameters from last time</button>
		<p id = 'parameter_text'> saved parameters: </p>


		<!-- Bootstrap core JavaScript
		================================================== -->
		<!-- Placed at the end of the document so the pages load faster 
		Replace with local file later
		-->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

		<!-- local files -->
		<!--<link rel="stylesheet" href="{{url_for('static', filename='css/bootstrap.min.css') }}">-->
		<!-- Custom styles for this template -->
		<!--<link rel="stylesheet" href="{{url_for('static', filename='css/custom_style.css') }}">
-->

		<!-- javascript -->

		
		<script src="http://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
		
		<!-- local files -->
<!--		<script type=text/javascript src="{{url_for('static', filename='js/jquery-3.1.1.slim.min.js') }}"></script>
		<script type=text/javascript src="{{url_for('static', filename='js/bootstrap.min.js') }}"></script>
		<script type=text/javascript src="{{url_for('static', filename='js/tether.min.js') }}"></script>-->


		<!-- customised scripts -->


		<script>
			"use strict";
		
			// control the camera parameters
			let camera_params = {
			width: 1280,
			height: 720,
			fps: 10,
			sharpness: 0,
			brightness: 50,
			contrast: 0,
			saturation: 0,
			};
		
			function onChangeSlider(obj){
			let param_name = $(obj).parent().prop("id");
			camera_params[param_name] = $(obj).prop('value');
			$(obj).siblings('input[type="text"]').prop('value', camera_params[param_name]);
			}
		
			function onChangeText(obj){
			let param_name = $(obj).parent().prop("id");
			camera_params[param_name] = $(obj).prop('value');
			$(obj).siblings('input[type="range"]').prop('value', camera_params[param_name]);
			}
		
			function openSetting(evt, SettingName) {
				// Declare all variables
				let i, tabcontent, tablinks;
		
				// Get all elements with class="tabcontent" and hide them
				tabcontent = document.getElementsByClassName("tabcontent");
				for (i = 0; i < tabcontent.length; i++) {
					tabcontent[i].style.display = "none";
				}
		
				// Get all elements with class="tablinks" and remove the class "active"
				tablinks = document.getElementsByClassName("tablinks");
				for (i = 0; i < tablinks.length; i++) {
					tablinks[i].className = tablinks[i].className.replace(" active", "");
				}
		
				// Show the current tab, and add an "active" class to the button that opened the tab
				document.getElementById(SettingName).style.display = "block";
				evt.currentTarget.className += " active";
			}
		

			// control the streaming
			const STREAM_URL = 'http://10.0.0.1:8080/?action=stream';
			const STREAM_CTL_URL = 'start_stream';
			const STREAM_STOP_URL = 'stop_stream';
			const CAPTURE_URL = 'capture';
			const MOTOR_CTL_URL = 'move';
			const LED_CTL_URL = 'led';
			const MICROSWITCH_URL = 'microswitch';
		
			// use ajax to update the image at STREAM_URL
			function start_stream(params){
			$.ajax({
				url: STREAM_CTL_URL,
				data: params,
				success: function(){
				load_stream(params['width'], params['height']);
				},
				error: function(){
				alert('Could not restart stream with new parameters');
				}
			});
			}

			// load stream as an image (static)
			function load_stream(width=1280, height=720){
			$('#stream_container').empty()
				.append(`<img id="stream" width="${width}" height="${height}" src="${STREAM_URL}" style=""/>`);
			}
		
			// stop stream
			function stop_stream(params){
			$.ajax({
				url: STREAM_STOP_URL,
				data: params,
				success: function(){
				},
				error: function(){
				}
			});
			}


			// capture image by saving the jpeg in the streaming frame
			function capture(params){
			$.ajax({
				url: CAPTURE_URL,
				data: params,
				success: function(){
				load_stream(params['width'], params['height']);
				// Simulate the user clicking on the hidden download link to prompt to save the image
				$('#capture_link')[0].click();
				},
				error: function(){
				load_stream(params['width'], params['height']);
				alert('Error when attempting to capture image');
				}
			});
			}


			// Execute this when document has loaded - start stream on loading the page
			function start_stream(){
				load_stream(camera_params['width'], camera_params['height']);
				$('.tabcontent > input[type="range"]').each(function(){
				$(this).on("change", function(){
					onChangeSlider(this);
				});
				});
				$('.tabcontent > input[type="text"]').each(function(){
				$(this).on("change", function(){
					onChangeText(this);
				});
				});
				}

				
			</script>
		

		<!-- JQuerey scripts -->

		<script>
			$(document).ready(function(){
				
/*				$("p").click(function(){
					$(this).hide();
				});*/

				// Update the value of text box with slider
				$("#brightness_slider").change(function(){
					var brightness = $("#brightness_slider").val();
					$('#brightness_text').text(brightness);
				});
				
				// Update the value of text box with slider
				$("#contrast_slider").change(function(){
					var contrast = $("#contrast_slider").val();
					$('#contrast_text').text(contrast);
				});
				

				// Update the value of text box with slider
				$("#blue_gain_slider").change(function(){
					var blue_gain = $("#blue_gain_slider").val();
					$('#blue_gain_text').text(blue_gain);
				});

				// Update the value of text box with slider
				$("#red_gain_slider").change(function(){
					var red_gain = $("#red_gain_slider").val();
					$('#red_gain_text').text(red_gain);
				});

				// Update the value of text box with slider
				$("#file_path_text").change(function(){
					var red_gain = $("#red_gain_slider").val();
					$('#red_gain_text').text(red_gain);
				});

				// run python script with a button
				$('#time_lapse_button').click(function(){
					stop_stream();
					$.ajax({
						url: '/time_lapse_module',
						//data: $('form').serialize(),
						type: 'POST',
						success: function(response) {
							console.log(response);
						},
						error: function(error) {
							console.log(error);
						}
					});
				});


				$('#update_parameters_button').click(function(){
					var brightness = $("#brightness_slider").val();
					var contrast = $("#contrast_slider").val();
					var blue_gain = $("#blue_gain_slider").val();
					var red_gain = $("#red_gain_slider").val();
					var filepath = $("#file_path_text").val();
					var parameters = {Brightness:brightness, Contrast:contrast, Blue_gain:blue_gain, Red_gain:red_gain, Filepath:filepath}

					$.ajax({
						url: '/update_parameters',
						type: 'POST',
						data: JSON.stringify(parameters),
						contentType: 'application/json; charset=utf-8',
						dataType: 'json',
						async: false,
						success: function(response, msg) {
							console.log(response);
							alert(msg);
						},
						error: function(error) {
							console.log(error);
						},
					});
				});
			
				// use variables from flask directly
				$("#read_parameters_button_1").click(function(){
					$.getJSON("/read_parameters", function(result){
						alert("Data: " + result.data_2 );
					});
				});

				// use ajax or getJSON to obtain JSON file or variables from flask
				$("#read_parameters_button").click(function(){
					$.ajax({
						dataType: "json",
						url: "/read_parameters",
						success: function(result){
							$("#brightness_slider").val(result.brightness);
							$("#contrast_slider").val(result.contrast);
							$("#blue_gain_slider").val(result.blue_gain);
							$("#red_gain_slider").val(result.red_gain);
							
							$("#brightness_text").text(result.brightness);
							$("#contrast_text").text(result.contrast);
							$("#blue_gain_text").text(result.blue_gain);
							$("#red_gain_text").text(result.red_gain);
							$("#file_path_text").text(result.filepath);
							
						}
					});
				});


				// Execute this when document has loaded - start stream on loading the page
				$(function(){
					load_stream(camera_params['width'], camera_params['height']);
					$('.tabcontent > input[type="range"]').each(function(){
					$(this).on("change", function(){
						onChangeSlider(this);
					});
					});
					$('.tabcontent > input[type="text"]').each(function(){
					$(this).on("change", function(){
						onChangeText(this);
					});
					});
				});

			});
		</script>




	</body>
</html>
